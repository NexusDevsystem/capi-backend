// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  
  // Encrypted sensitive data
  phone         String?
  taxId         String?
  phoneHash     String?  @unique
  taxIdHash     String?  @unique
  
  role          String   @default("Aguardando") // Proprietário, Administrador, Gerente, Vendedor, Técnico, Aguardando
  status        String   @default("Pendente")   // Ativo, Ausente, Pendente
  avatarUrl     String?
  googleId      String?  @unique
  
  // Subscription
  subscriptionStatus String   @default("FREE") // FREE, TRIAL, ACTIVE, PENDING, CANCELED
  trialEndsAt        DateTime?
  nextBillingAt      DateTime?
  memberSince        DateTime @default(now())
  lastAccess         DateTime @default(now())
  
  // Multi-store
  activeStoreId String?
  activeStore   Store?  @relation("ActiveStore", fields: [activeStoreId], references: [id])
  
  // Relations
  ownedStores   Store[]     @relation("OwnedStores")
  storeUsers    StoreUser[]
  invoices      Invoice[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
  @@index([googleId])
  @@index([phoneHash])
  @@index([taxIdHash])
}

// ============================================
// STORE & MULTI-TENANCY
// ============================================

model Store {
  id       String  @id @default(uuid())
  name     String
  ownerId  String
  owner    User    @relation("OwnedStores", fields: [ownerId], references: [id])
  
  address  String?
  phone    String?
  logoUrl  String?
  
  // Settings stored as JSON
  settings Json    @default("{}")
  
  // Store status
  isOpen        Boolean   @default(false)
  lastOpenedAt  DateTime?
  lastClosedAt  DateTime?
  openedBy      String?
  closedBy      String?
  
  // Relations
  storeUsers     StoreUser[]
  transactions   Transaction[]
  customers      Customer[]
  products       Product[]
  serviceOrders  ServiceOrder[]
  bankAccounts   BankAccount[]
  cashClosings   CashClosing[]
  suppliers      Supplier[]
  activeUsers    User[]         @relation("ActiveStore")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([ownerId])
  @@index([name])
}

model StoreUser {
  id      String @id @default(uuid())
  userId  String
  user    User   @relation(fields: [userId], references: [id])
  storeId String
  store   Store  @relation(fields: [storeId], references: [id])
  
  role        String   // owner, admin, manager, seller, technician
  permissions String[] @default([])
  status      String   @default("active") // active, Ativo, Pendente, inactive
  
  // Financial
  salary     Float?
  commission Float?
  
  // Metadata
  joinedAt  DateTime @default(now())
  invitedBy String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([userId, storeId])
  @@index([storeId])
  @@index([userId])
}

// ============================================
// FINANCIAL
// ============================================

model Transaction {
  id          String   @id @default(uuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])
  
  description String?
  amount      Float
  type        String   // INCOME, EXPENSE
  category    String?
  paymentMethod String? // Pix, Dinheiro, Crédito, Débito, Boleto, Outro
  status      String   @default("COMPLETED") // PENDING, COMPLETED, PAID, OVERDUE, SCHEDULED
  date        DateTime @default(now())
  entity      String?  // Customer/Supplier name
  
  // Items sold (stored as JSON for flexibility)
  items Json?
  
  bankAccountId String?
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id])
  
  // Flags
  isDebtPayment Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([storeId])
  @@index([date(sort: Desc)])
  @@index([type])
  @@index([status])
}

model BankAccount {
  id       String  @id @default(uuid())
  storeId  String
  store    Store   @relation(fields: [storeId], references: [id])
  
  name     String?
  type     String?
  balance  Float   @default(0)
  
  transactions Transaction[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([storeId])
}

model CashClosing {
  id            String   @id @default(uuid())
  storeId       String
  store         Store    @relation(fields: [storeId], references: [id])
  
  date          DateTime
  totalRevenue  Float
  totalExpense  Float
  balance       Float
  
  // Breakdown by payment method (stored as JSON)
  breakdown Json @default("{\"pix\": 0, \"cash\": 0, \"card\": 0, \"other\": 0}")
  
  notes     String?
  closedBy  String?
  closedAt  DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([storeId])
  @@index([date(sort: Desc)])
}

model Invoice {
  id     String   @id @default(uuid())
  userId String
  user   User     @relation(fields: [userId], references: [id])
  
  date   DateTime
  amount Float
  status String   // PAID, PENDING, EXPIRED
  method String?  // PIX, CARD, MANUAL
  url    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@index([date(sort: Desc)])
  @@index([status])
}

// ============================================
// INVENTORY & PRODUCTS
// ============================================

model Product {
  id       String  @id @default(uuid())
  storeId  String
  store    Store   @relation(fields: [storeId], references: [id])
  
  name     String
  sku      String?
  barcode  String?
  
  // Pricing
  costPrice Float @default(0)
  salePrice Float @default(0)
  
  // Stock
  stock    Int @default(0)
  minStock Int @default(0)
  
  expiryDate DateTime?
  
  // Tax data (stored as JSON)
  taxData Json @default("{}")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([storeId])
  @@index([sku])
  @@index([barcode])
}

// ============================================
// CRM & CUSTOMERS
// ============================================

model Customer {
  id       String  @id @default(uuid())
  storeId  String
  store    Store   @relation(fields: [storeId], references: [id])
  
  name     String
  
  // Encrypted phone
  phone     String?
  phoneHash String?
  
  // Crediário (account balance)
  balance Float @default(0)
  
  // Purchase/debt history (stored as JSON array)
  items Json @default("[]")
  
  lastUpdate DateTime?
  
  // CRM Pipeline
  pipelineStage String? // LEAD, NEGOCIACAO, FECHADO, PERDIDO
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([storeId])
  @@index([phoneHash])
  @@index([pipelineStage])
}

model Supplier {
  id       String  @id @default(uuid())
  storeId  String
  store    Store   @relation(fields: [storeId], references: [id])
  
  name        String
  contactName String?
  email       String?
  
  // Encrypted phone
  phone     String?
  phoneHash String?
  
  category String?
  notes    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([storeId])
  @@index([phoneHash])
}

// ============================================
// SERVICE ORDERS
// ============================================

model ServiceOrder {
  id           String  @id @default(uuid())
  storeId      String
  store        Store   @relation(fields: [storeId], references: [id])
  
  customerId   String?
  customerName String?
  device       String?
  description  String?
  status       String  @default("ABERTO") // ABERTO, EM_ANALISE, AGUARDANDO_PECA, CONCLUIDO, ENTREGUE
  
  // Pricing
  partsTotal Float @default(0)
  laborTotal Float @default(0)
  total      Float @default(0)
  
  openDate DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([storeId])
  @@index([status])
  @@index([openDate(sort: Desc)])
}
