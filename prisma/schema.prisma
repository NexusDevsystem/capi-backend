// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- USERS & AUTH ---

model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  
  // Encrypted Fields
  phone     String?
  taxId     String?
  
  // Blind Indexes (for searching)
  phoneHash String?
  taxIdHash String?
  
  role      String   @default("Aguardando")
  status    String   @default("Pendente")
  avatarUrl String?
  googleId  String?  @unique
  
  // Subscription
  subscriptionStatus String    @default("FREE")
  trialEndsAt        DateTime?
  nextBillingAt      DateTime?
  memberSince        DateTime  @default(now())
  lastAccess         DateTime  @default(now())
  
  // Relations
  stores         StoreUser[]
  ownedStores    Store[]       @relation("Owner")
  invoices       Invoice[]
  
  // Tracking
  activeStoreId  String?
  
  @@map("users")
}

model Store {
  id           String      @id @default(uuid())
  name         String
  ownerId      String
  owner        User        @relation("Owner", fields: [ownerId], references: [id])
  address      String?
  phone        String?
  logoUrl      String?
  
  // Settings (JSON)
  settings     Json?
  
  // Status
  isOpen       Boolean     @default(false)
  lastOpenedAt DateTime?
  lastClosedAt DateTime?
  openedBy     String?
  closedBy     String?
  
  // Relations
  team         StoreUser[]
  products     Product[]
  transactions Transaction[]
  customers    Customer[]
  suppliers    Supplier[]
  bankAccounts BankAccount[]
  cashClosings CashClosing[]
  serviceOrders ServiceOrder[]
  
  createdAt    DateTime    @default(now())

  @@map("stores")
}

model StoreUser {
  id        String   @id @default(uuid())
  userId    String
  storeId   String
  role      String
  user      User     @relation(fields: [userId], references: [id])
  store     Store    @relation(fields: [storeId], references: [id])
  
  permissions String[] 
  joinedAt    DateTime @default(now())
  status      String   @default("active")
  invitedBy   String?
  
  // Financial
  salary      Float?
  commission  Float?

  @@unique([userId, storeId])
  @@map("store_users")
}

// --- FINANCIAL & ERP ---

model Product {
  id          String   @id @default(uuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])
  
  name        String
  sku         String?
  barcode     String?
  costPrice   Decimal?  @db.Decimal(10, 2)
  salePrice   Decimal?  @db.Decimal(10, 2)
  stock       Int?
  minStock    Int?
  expiryDate  DateTime?
  
  // Tax Data (NCM, CEST, CFOP, Origin)
  taxData     Json? 

  @@map("products")
}

model Transaction {
  id            String   @id @default(uuid())
  storeId       String
  store         Store    @relation(fields: [storeId], references: [id])
  
  description   String?
  amount        Decimal  @db.Decimal(12, 2)
  type          String   // INCOME, EXPENSE
  category      String?
  paymentMethod String?
  status        String?
  date          DateTime
  
  entity        String? // Name of person involved
  items         Json?    // Array of objects { productName, quantity, unitPrice, total }
  
  bankAccountId String?

  @@map("transactions")
}

model Invoice {
  id        String   @id @default(uuid()) // Can happen to be 'MANUAL-...'
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  date      DateTime
  amount    Decimal  @db.Decimal(10, 2)
  status    String
  method    String? // PIX, CARD, MANUAL
  url       String?
  
  @@map("invoices")
}

model Customer {
  id            String   @id @default(uuid())
  storeId       String
  store         Store    @relation(fields: [storeId], references: [id])
  
  name          String
  phone         String?
  phoneHash     String?
  
  balance       Decimal? @default(0) @db.Decimal(10, 2)
  
  // Simple purchase history log
  items         Json? 
  
  lastUpdate    DateTime?
  pipelineStage String?

  @@map("customers")
}

model Supplier {
  id          String   @id @default(uuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])
  
  name        String
  contactName String?
  email       String?
  phone       String?
  phoneHash   String?
  
  category    String?
  notes       String?

  @@map("suppliers")
}

model BankAccount {
  id      String   @id @default(uuid())
  storeId String
  store   Store    @relation(fields: [storeId], references: [id])
  
  name    String?
  type    String?
  balance Decimal? @db.Decimal(12, 2)

  @@map("bank_accounts")
}

model CashClosing {
  id           String   @id @default(uuid())
  storeId      String
  store        Store    @relation(fields: [storeId], references: [id])
  
  date         DateTime
  totalRevenue Decimal  @db.Decimal(12, 2)
  totalExpense Decimal  @db.Decimal(12, 2)
  balance      Decimal  @db.Decimal(12, 2)
  
  // Breakdown { pix: 10, cash: 20 }
  breakdown    Json?
  
  notes        String?
  closedBy     String?
  closedAt     DateTime?

  @@map("cash_closings")
}

model ServiceOrder {
  id           String   @id @default(uuid())
  storeId      String
  store        Store    @relation(fields: [storeId], references: [id])
  
  customerId   String?
  customerName String?
  device       String?
  description  String?
  status       String?
  
  partsTotal   Decimal? @db.Decimal(10, 2)
  laborTotal   Decimal? @db.Decimal(10, 2)
  total        Decimal? @db.Decimal(10, 2)
  
  openDate     DateTime?

  @@map("service_orders")
}
